<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø¯Ø±ÙˆØ³ÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø©</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --primary-color: #4f46e5;
            --font-family: 'Cairo', sans-serif;
        }
        body { 
            font-family: var(--font-family); 
            background-image: url('https://i.postimg.cc/XvfW383N/download-37.jpg');
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
            -webkit-tap-highlight-color: transparent;
        }
        .element-3d {
            background-color: white;
            border: 2px solid #4b5563;
            position: relative;
            transition: transform 0.15s ease-out, box-shadow 0.15s ease-out;
            cursor: pointer;
        }
        .element-3d.btn-style { box-shadow: 0 5px 0 0 #4b5563; }
        .element-3d.card-style { box-shadow: 0 8px 0 0 #6b7280; }
        .element-3d:hover { transform: translateY(-4px); }
        .element-3d.btn-style:hover { box-shadow: 0 9px 0 0 #374151; }
        .element-3d.card-style:hover { box-shadow: 0 12px 0 0 #4b5563; }
        .element-3d:active { transform: translateY(1px); }
        .element-3d.btn-style:active { box-shadow: 0 2px 0 0 #374151; }
        .element-3d.card-style:active { box-shadow: 0 4px 0 0 #4b5563; }
        .content-panel {
            background-color: rgba(241, 245, 249, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        #progress-bar-fill { background-color: var(--primary-color); }
        #volume-slider { accent-color: var(--primary-color); }
        #time-display { direction: ltr; }
        #content-list { padding-bottom: 1rem; }
        .scrolling-wrapper { -ms-overflow-style: none; scrollbar-width: none; }
        .scrolling-wrapper::-webkit-scrollbar { display: none; }
        #dynamic-header-area {
            background-color: rgba(241, 245, 249, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }
    </style>
</head>
<body class="antialiased bg-slate-200">
    
    <!-- ACCESS LOCK OVERLAY -->
    <div id="access-lock-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4"><div class="w-full max-w-md text-center content-panel rounded-3xl p-8"><h2 class="text-4xl font-bold text-slate-900 mb-3">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</h2><p class="text-slate-600 mb-8">Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„.</p><form id="login-form" class="space-y-6"><input type="text" id="secret-code-input" placeholder="â— â— â— â— â— â—" maxlength="6" required class="w-full px-4 py-3 text-2xl tracking-[1.5rem] text-center bg-white border-2 border-gray-600 rounded-xl"><button type="submit" class="w-full element-3d btn-style bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl">Ø§Ù„ØªØ­Ù‚Ù‚</button></form><div class="mt-8"><p class="text-gray-700 mb-3">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø±Ù…Ø²ØŸ</p><a href="https://wa.me/201202687082" target="_blank" class="inline-flex items-center gap-3 px-6 py-3 element-3d btn-style bg-green-500 text-white font-semibold rounded-full"><i class="fab fa-whatsapp text-xl"></i> <span>ÙˆØ§ØªØ³Ø§Ø¨</span></a></div></div></div>
    
    <!-- GRADE SELECTION OVERLAY -->
    <div id="grade-selection-overlay" class="fixed inset-0 z-40 items-start justify-center p-4 hidden overflow-y-auto bg-slate-900/30 backdrop-blur-sm">
        <div class="w-full max-w-4xl text-center my-8">
            <div class="pt-16 sm:pt-24">
                 <h1 class="text-6xl font-extrabold text-white mb-4" style="text-shadow: 0 4px 8px rgba(0,0,0,0.4);"><i class="fas fa-graduation-cap"></i></h1>
                 <h2 class="text-4xl font-extrabold text-white mb-2" style="text-shadow: 0 2px 6px rgba(0,0,0,0.4);">Ø¯Ø±ÙˆØ³ÙŠ</h2>
                 <p class="text-slate-200 mb-12">Ø§Ø®ØªØ± Ù…Ø±Ø­Ù„ØªÙƒ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ù„Ù„Ø¨Ø¯Ø¡</p>
            </div>
            <div id="grade-options" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
            <div id="second-secondary-options" class="hidden mt-6">
                <h3 class="text-xl font-bold text-white mb-4" style="text-shadow: 0 2px 4px rgba(0,0,0,0.3);">Ø§Ø®ØªØ± ØªØ®ØµØµÙƒ</h3>
                <div id="second-sec-buttons" class="flex justify-center gap-4"></div>
            </div>
        </div>
    </div>

    <!-- MAIN PLATFORM -->
    <main id="main-platform" class="hidden text-slate-800">
        <div class="lg:flex lg:flex-row-reverse lg:h-screen">
            <!-- VIDEO DISPLAY AREA -->
            <div class="video-display-area w-full bg-black lg:flex-grow lg:sticky lg:top-0 lg:h-screen"><div id="player-wrapper" class="w-full h-full relative group aspect-video lg:aspect-auto"><div id="player-placeholder" class="w-full h-full flex flex-col justify-center items-center text-center p-4 bg-slate-900"><i class="fas fa-play-circle text-6xl mb-4 text-indigo-400/50"></i><p class="font-semibold text-slate-300">Ø§Ø®ØªØ± ÙÙŠØ¯ÙŠÙˆ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</p></div><div id="youtube-player" class="w-full h-full"></div><div class="absolute top-0 inset-x-0 h-28 bg-gradient-to-b from-black/60 to-transparent pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity z-10"><h1 class="text-2xl font-extrabold text-white p-4 opacity-70"><i class="fas fa-graduation-cap"></i> Ø¯Ø±ÙˆØ³ÙŠ</h1></div><div id="custom-controls-overlay" class="absolute bottom-0 inset-x-0 z-10 p-2 sm:p-4 flex flex-col gap-2 bg-gradient-to-t from-black/80 to-transparent opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-opacity"><div id="progress-bar-container" class="w-full h-1.5 hover:h-2.5 bg-white/20 cursor-pointer rounded-full"><div id="progress-bar-fill" class="h-full rounded-full w-0"></div></div><div class="controls-bottom-row flex items-center gap-2 sm:gap-4 text-white"><button id="play-pause-btn" class="text-2xl w-8 h-8 flex shrink-0 items-center justify-center hover:text-indigo-400"><i class="fas fa-play"></i></button><div class="flex items-center gap-2"><button id="mute-btn" class="text-xl w-8 h-8 flex shrink-0 items-center justify-center hover:text-indigo-400"><i class="fas fa-volume-up"></i></button><input type="range" id="volume-slider" min="0" max="100" value="100" class="w-16 sm:w-20 h-1 cursor-pointer"></div><div id="time-display" class="text-sm font-mono tracking-tighter">00:00/00:00</div><div class="flex-grow"></div><button id="fullscreen-btn" class="text-xl w-8 h-8 flex shrink-0 items-center justify-center hover:text-indigo-400"><i class="fas fa-expand"></i></button></div></div></div></div>

            <!-- CONTENT AREA -->
            <div class="w-full lg:w-[400px] lg:flex-shrink-0 lg:h-screen lg:overflow-y-auto">
                <div class="content-panel min-h-full">
                    <div class="pt-8 pb-4 text-center"><h1 class="text-4xl font-extrabold text-indigo-600"><i class="fas fa-graduation-cap"></i> Ø¯Ø±ÙˆØ³ÙŠ</h1><p class="text-slate-600 text-sm mt-1">Ù…Ù†ØµØªÙƒ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰</p></div>
                    <div class="px-4 pb-4"><form id="search-form" class="element-3d btn-style relative flex items-center bg-white rounded-full p-1"><input type="search" id="search-bar" placeholder="Ø§Ø¨Ø­Ø«..." class="flex-grow pl-4 pr-10 py-2 bg-transparent border-0 rounded-full focus:outline-none focus:ring-0 text-slate-800"><button type="submit" class="absolute inset-y-0 left-0 flex items-center justify-center w-12 text-slate-400 hover:text-indigo-600 rounded-full"><i class="fas fa-magnifying-glass"></i></button></form></div>
                    <div class="h-6 lg:hidden"></div>
                    <div id="dynamic-header-area" class="sticky top-0 z-20 p-4 space-y-4 border-y border-white/20">
                        <div id="main-view-header" class="hidden">
                            <div id="grade-header" class="items-center gap-4 bg-white/50 rounded-2xl shadow-sm border border-slate-200 p-4"></div>
                            <div id="category-filters" class="scrolling-wrapper flex items-center gap-3 overflow-x-auto pt-2 pb-2"></div>
                        </div>
                        <div id="sub-view-header" class="hidden items-center">
                            <button id="back-btn" class="element-3d btn-style rounded-full w-10 h-10 flex items-center justify-center bg-white text-slate-700 ml-3"><i class="fas fa-arrow-left"></i></button>
                            <h2 id="view-title" class="font-bold text-lg text-slate-800 truncate"></h2>
                        </div>
                    </div>
                    <div id="content-list" class="p-4 space-y-4"></div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://www.youtube.com/iframe_api"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONSTANTS AND GLOBAL VARIABLES ---
        const SECRET_CODE_FOR_LOGIN = "SASAIF";
        const YOUTUBE_API_KEY = "AIzaSyA4gfRf5sGQZ-a7ficcTcgU47aJV30cSgc";
        let player, progressInterval;
        let currentSubjectQuery, currentSubjectName;

        const appData = {
            grades: {
                prep_1: { name: "Ø£ÙˆÙ„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ", emoji: '1ï¸âƒ£', color: 'bg-green-400', subjects: [ { n: 'Ø¹Ø±Ø¨ÙŠ', q: 'Ø´Ø±Ø­ Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ©' }, { n: 'Ø¹Ù„ÙˆÙ…', q: 'Ø´Ø±Ø­ Ø¹Ù„ÙˆÙ…' }, { n: 'Ø±ÙŠØ§Ø¶Ø©', q: 'Ø´Ø±Ø­ Ø±ÙŠØ§Ø¶ÙŠØ§Øª' }, { n: 'Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ', q: 'Ø´Ø±Ø­ Ù„ØºØ© Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©' }, { n: 'Ø¯Ø±Ø§Ø³Ø§Øª', q: 'Ø´Ø±Ø­ Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©' } ] },
                prep_2: { name: "Ø«Ø§Ù†ÙŠØ© Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ", emoji: '2ï¸âƒ£', color: 'bg-sky-400', subjects: [ { n: 'Ø¹Ø±Ø¨ÙŠ', q: 'Ø´Ø±Ø­ Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ©' }, { n: 'Ø¹Ù„ÙˆÙ…', q: 'Ø´Ø±Ø­ Ø¹Ù„ÙˆÙ…' }, { n: 'Ø±ÙŠØ§Ø¶Ø©', q: 'Ø´Ø±Ø­ Ø±ÙŠØ§Ø¶ÙŠØ§Øª' }, { n: 'Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ', q: 'Ø´Ø±Ø­ Ù„ØºØ© Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©' }, { n: 'Ø¯Ø±Ø§Ø³Ø§Øª', q: 'Ø´Ø±Ø­ Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©' } ] },
                prep_3: { name: "Ø«Ø§Ù„Ø«Ø© Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ", emoji: '3ï¸âƒ£', color: 'bg-purple-400', subjects: [ { n: 'Ø¹Ø±Ø¨ÙŠ', q: 'Ø´Ø±Ø­ Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ©' }, { n: 'Ø¹Ù„ÙˆÙ…', q: 'Ø´Ø±Ø­ Ø¹Ù„ÙˆÙ…' }, { n: 'Ø±ÙŠØ§Ø¶Ø©', q: 'Ø´Ø±Ø­ Ø±ÙŠØ§Ø¶ÙŠØ§Øª' }, { n: 'Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ', q: 'Ø´Ø±Ø­ Ù„ØºØ© Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©' }, { n: 'Ø¯Ø±Ø§Ø³Ø§Øª', q: 'Ø´Ø±Ø­ Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©' } ] },
                sec_1: { name: "Ø£ÙˆÙ„Ù‰ Ø«Ø§Ù†ÙˆÙŠ", emoji: 'ğŸ“', color: 'bg-red-400', subjects: [ { n: 'Ø¹Ø±Ø¨ÙŠ', q: 'Ø´Ø±Ø­ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' }, { n: 'Ø¹Ù„ÙˆÙ… Ù…ØªÙƒØ§Ù…Ù„Ø©', q: 'Ø´Ø±Ø­ Ø¹Ù„ÙˆÙ… Ù…ØªÙƒØ§Ù…Ù„Ø©' }, { n: 'Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ', q: 'Ø´Ø±Ø­ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©' }, { n: 'Ø±ÙŠØ§Ø¶Ø©', q: 'Ø´Ø±Ø­ Ø±ÙŠØ§Ø¶ÙŠØ§Øª' } ] },
                sec_2_sci: { name: "Ø«Ø§Ù†ÙŠØ© Ø«Ø§Ù†ÙˆÙŠ - Ø¹Ù„Ù…ÙŠ", emoji: 'ğŸ”¬', subjects: [ { n: 'Ø¹Ø±Ø¨ÙŠ', q: 'Ø´Ø±Ø­ Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ©' }, { n: 'ÙÙŠØ²ÙŠØ§Ø¡', q: 'Ø´Ø±Ø­ ÙÙŠØ²ÙŠØ§Ø¡' }, { n: 'ÙƒÙŠÙ…ÙŠØ§Ø¡', q: 'Ø´Ø±Ø­ ÙƒÙŠÙ…ÙŠØ§Ø¡' }, { n: 'Ø±ÙŠØ§Ø¶Ø©', q: 'Ø´Ø±Ø­ Ø±ÙŠØ§Ø¶ÙŠØ§Øª' }, { n: 'Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ', q: 'Ø´Ø±Ø­ Ù„ØºØ© Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©' } ] },
                sec_2_lit: { name: "Ø«Ø§Ù†ÙŠØ© Ø«Ø§Ù†ÙˆÙŠ - Ø£Ø¯Ø¨ÙŠ", emoji: 'ğŸ›ï¸', subjects: [ { n: 'Ø¹Ø±Ø¨ÙŠ', q: 'Ø´Ø±Ø­ Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ©' }, { n: 'ØªØ§Ø±ÙŠØ®', q: 'Ø´Ø±Ø­ ØªØ§Ø±ÙŠØ®' }, { n: 'Ø¬ØºØ±Ø§ÙÙŠØ§', q: 'Ø´Ø±Ø­ Ø¬ØºØ±Ø§ÙÙŠØ§' }, { n: 'Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ', q: 'Ø´Ø±Ø­ Ù„ØºØ© Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©' }, { n: 'ÙÙ„Ø³ÙØ© ÙˆØ¹Ù„Ù… Ù†ÙØ³', q: 'Ø´Ø±Ø­ ÙÙ„Ø³ÙØ© ÙˆØ¹Ù„Ù… Ù†ÙØ³' } ] }
            },
            currentUser: { gradeId: null, gradeData: null }
        };

        // --- DOM ELEMENT SELECTORS ---
        const accessLockOverlay = document.getElementById('access-lock-overlay');
        const loginForm = document.getElementById('login-form');
        const gradeSelectionOverlay = document.getElementById('grade-selection-overlay');
        const mainPlatform = document.getElementById('main-platform');
        const contentList = document.getElementById('content-list');
        const mainViewHeader = document.getElementById('main-view-header');
        const subViewHeader = document.getElementById('sub-view-header');
        const backBtn = document.getElementById('back-btn');
        const categoryFiltersDiv = document.getElementById('category-filters');
        const playerWrapper = document.getElementById('player-wrapper');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const muteBtn = document.getElementById('mute-btn');
        const volumeSlider = document.getElementById('volume-slider');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const progressBarFill = document.getElementById('progress-bar-fill');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const timeDisplay = document.getElementById('time-display');

        // --- AUTH & GRADE SELECTION ---
        function checkGradeSelection() {
            const savedGrade = localStorage.getItem('userGrade');
            if (savedGrade && appData.grades[savedGrade]) startAppForGrade(savedGrade);
            else displayGradeSelection();
        }

        function displayGradeSelection() {
            gradeSelectionOverlay.style.display = 'flex';
            const gradeOptionsContainer = document.getElementById('grade-options');
            const secondSecOptions = document.getElementById('second-secondary-options');
            const secondSecButtons = document.getElementById('second-sec-buttons');
            gradeOptionsContainer.innerHTML = ''; secondSecButtons.innerHTML = '';
            const mainGrades = [ { id: 'prep_1' }, { id: 'prep_2' }, { id: 'prep_3' }, { id: 'sec_1' }, { id: 'sec_2' } ];
            mainGrades.forEach(g => {
                const btn = document.createElement('button');
                btn.className = 'element-3d card-style p-5 font-bold rounded-2xl flex flex-col items-center gap-3 text-slate-800';
                if (g.id === 'sec_2') {
                    btn.innerHTML = `<span class="text-4xl">âœŒï¸</span><span>Ø«Ø§Ù†ÙŠØ© Ø«Ø§Ù†ÙˆÙŠ</span>`;
                    btn.classList.add('bg-amber-300');
                    btn.addEventListener('click', () => { gradeOptionsContainer.classList.add('hidden'); secondSecOptions.classList.remove('hidden'); });
                } else {
                    const d = appData.grades[g.id];
                    btn.dataset.grade = g.id; btn.innerHTML = `<span class="text-4xl">${d.emoji}</span><span>${d.name}</span>`;
                    btn.classList.add(d.color); btn.addEventListener('click', () => startAppForGrade(g.id));
                }
                gradeOptionsContainer.appendChild(btn);
            });
            const sec2_choices = [ { id: 'sec_2_sci', name: 'Ø¹Ù„Ù…ÙŠ', emoji: 'ğŸ”¬', color: 'bg-sky-300' }, { id: 'sec_2_lit', name: 'Ø£Ø¯Ø¨ÙŠ', emoji: 'ğŸ›ï¸', color: 'bg-orange-300' } ];
            sec2_choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'element-3d card-style text-lg w-full sm:w-48 text-slate-800 flex flex-col items-center gap-3 p-5 font-bold rounded-2xl';
                btn.dataset.grade = choice.id; btn.classList.add(choice.color);
                btn.innerHTML = `<span class="text-3xl">${choice.emoji}</span><span>${choice.name}</span>`;
                btn.addEventListener('click', () => startAppForGrade(choice.id));
                secondSecButtons.appendChild(btn);
            });
        }

        function startAppForGrade(gradeId) {
            localStorage.setItem('userGrade', gradeId);
            appData.currentUser = { gradeId: gradeId, gradeData: appData.grades[gradeId] };
            gradeSelectionOverlay.classList.add('opacity-0');
            setTimeout(() => { 
                gradeSelectionOverlay.style.display = 'none'; 
                mainPlatform.classList.remove('hidden');
                initializeApp(); 
            }, 500);
        }

        // --- MAIN APP LOGIC ---
        function initializeApp() {
            const gradeHeader = document.getElementById('grade-header');
            const searchForm = document.getElementById('search-form');
            const categories = appData.currentUser.gradeData.subjects;

            gradeHeader.innerHTML = `<h2 class="font-extrabold text-lg text-slate-800">${appData.currentUser.gradeData.name}</h2><button id="change-grade-btn" class="text-xs text-slate-600 hover:text-indigo-600 font-semibold mr-auto">ØªØºÙŠÙŠØ±</button>`;
            gradeHeader.classList.remove('hidden'); gradeHeader.classList.add('flex');
            document.getElementById('change-grade-btn').addEventListener('click', () => { localStorage.removeItem('userGrade'); window.location.reload(); });

            function switchView(viewName, title = '') {
                contentList.innerHTML = '';
                if (viewName === 'main') {
                    mainViewHeader.style.display = 'block';
                    subViewHeader.style.display = 'none';
                } else { // 'sub-view' for results or playlist items
                    mainViewHeader.style.display = 'none';
                    subViewHeader.style.display = 'flex';
                    document.getElementById('view-title').textContent = title;
                }
            }

            function renderCategoryFilters() {
                categoryFiltersDiv.innerHTML = ''; 
                categories.forEach((cat) => {
                    const btn = document.createElement('button');
                    btn.className = 'category-filter element-3d btn-style shrink-0 px-4 py-2 rounded-full text-sm font-semibold text-slate-700';
                    btn.textContent = cat.n;
                    btn.addEventListener('click', () => {
                        currentSubjectQuery = cat.q;
                        currentSubjectName = cat.n;
                        fetchFromYouTube('video');
                    });
                    categoryFiltersDiv.appendChild(btn);
                });
            }
            
            function createToggle(currentType) {
                const toggleContainer = document.createElement('div');
                toggleContainer.className = "flex justify-center p-2 mb-4";
                const isVideo = currentType === 'video';
                
                toggleContainer.innerHTML = `
                    <div class="element-3d btn-style flex items-center bg-white rounded-full p-1 text-sm font-semibold">
                        <button class="toggle-btn w-28 py-2 rounded-full ${isVideo ? 'bg-indigo-600 text-white' : 'text-slate-600'}" data-type="video">
                            <i class="fas fa-video mr-2"></i>Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
                        </button>
                        <button class="toggle-btn w-28 py-2 rounded-full ${!isVideo ? 'bg-indigo-600 text-white' : 'text-slate-600'}" data-type="playlist">
                             <i class="fas fa-list-ul mr-2"></i>Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
                        </button>
                    </div>
                `;

                toggleContainer.querySelectorAll('.toggle-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const type = e.currentTarget.dataset.type;
                        if(type !== currentType) {
                            fetchFromYouTube(type);
                        }
                    });
                });

                return toggleContainer;
            }

            async function fetchFromYouTube(type, queryOverride = null) {
                const isPlaylistItems = type === 'playlistItems';
                const searchType = isPlaylistItems ? 'playlistItems' : (type === 'playlist' ? 'playlist' : 'video');
                const query = queryOverride || currentSubjectQuery;
                const title = `Ù…Ø§Ø¯Ø©: ${currentSubjectName}`;
                
                switchView('sub-view', title);
                contentList.innerHTML = '<p class="text-center p-4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>';

                const gradeName = appData.currentUser.gradeData.name.replace(/ - .*/, '');
                const fullQuery = `${query} Ù„Ù„ØµÙ ${gradeName}`;
                
                let apiUrl;
                if(isPlaylistItems) {
                    apiUrl = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${queryOverride}&maxResults=50&key=${YOUTUBE_API_KEY}`;
                } else {
                    apiUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(fullQuery)}&type=${searchType}&maxResults=20&key=${YOUTUBE_API_KEY}`;
                }

                try {
                    const res = await fetch(apiUrl);
                    if (!res.ok) throw new Error(`ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`);
                    const data = await res.json();
                    contentList.innerHTML = '';

                    if (!isPlaylistItems) {
                        contentList.appendChild(createToggle(type));
                    }
                    
                    if (data.items && data.items.length > 0) {
                        if (type === 'playlist') data.items.forEach(item => contentList.appendChild(createPlaylistCard(item)));
                        else if (type === 'video') data.items.forEach(item => contentList.appendChild(createSearchVideoCard(item)));
                        else if (isPlaylistItems) data.items.forEach(item => contentList.appendChild(createPlaylistItemCard(item)));
                    } else { 
                        contentList.innerHTML += '<p class="text-center p-4 text-slate-600">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬.</p>'; 
                    }
                } catch (err) { 
                    contentList.innerHTML = `<p class="text-center p-4 text-red-600">Ø­Ø¯Ø« Ø®Ø·Ø£: ${err.message}</p>`; 
                }
            }

            function createPlaylistCard(item) {
                const card = document.createElement("div");
                card.className = "element-3d card-style bg-white rounded-xl overflow-hidden";
                const thumbnailUrl = item.snippet.thumbnails.high?.url || item.snippet.thumbnails.medium.url;
                card.innerHTML = `<img src="${thumbnailUrl}" class="aspect-video w-full object-cover"><div class="p-4"><h3 class="font-bold text-sm text-slate-800 leading-tight line-clamp-2">${item.snippet.title}</h3></div>`;
                card.addEventListener('click', () => fetchFromYouTube('playlistItems', item.id.playlistId));
                return card;
            }

            function createSearchVideoCard(item) {
                const card = document.createElement("div");
                card.className = "element-3d card-style bg-white rounded-xl overflow-hidden";
                const thumbnailUrl = item.snippet.thumbnails.high?.url || item.snippet.thumbnails.medium.url;
                card.innerHTML = `<img src="${thumbnailUrl}" class="aspect-video w-full object-cover"><div class="p-4"><h3 class="font-bold text-sm text-slate-800 leading-tight line-clamp-2">${item.snippet.title}</h3></div>`;
                card.addEventListener("click", () => { createPlayer(item.id.videoId); playerWrapper.scrollIntoView({ behavior: 'smooth' }); });
                return card;
            }

            function createPlaylistItemCard(item) {
                const card = document.createElement("div");
                const thumbnailUrl = item.snippet.thumbnails?.high?.url || item.snippet.thumbnails?.medium?.url || 'https://i.ytimg.com/vi/default.jpg';
                card.className = "element-3d card-style bg-white rounded-xl overflow-hidden flex items-center gap-4 p-2";
                card.innerHTML = `<img src="${thumbnailUrl}" class="aspect-video w-28 object-cover rounded-lg"><h3 class="font-bold text-sm text-slate-800 leading-tight line-clamp-2 flex-grow">${item.snippet.title}</h3>`;
                card.addEventListener("click", () => { createPlayer(item.snippet.resourceId.videoId); playerWrapper.scrollIntoView({ behavior: 'smooth' }); });
                return card;
            }
            
            backBtn.addEventListener('click', () => switchView('main'));

            searchForm.addEventListener('submit', (e) => {
                e.preventDefault(); 
                const query = document.getElementById('search-bar').value.trim();
                if (query) {
                    currentSubjectQuery = query;
                    currentSubjectName = `Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†: "${query}"`;
                    fetchFromYouTube('video');
                }
            });

            renderCategoryFilters();
            
            // --- AUTO-LOAD FIRST SUBJECT ---
            if (categories && categories.length > 0) {
                const firstCategory = categories[0];
                currentSubjectQuery = firstCategory.q;
                currentSubjectName = firstCategory.n;
                fetchFromYouTube('video');
            } else {
                switchView('main'); // Fallback for grades with no subjects
            }
        }

        // --- YOUTUBE PLAYER API & CONTROLS ---
        function createPlayer(videoId) {
            document.getElementById('player-placeholder').style.display = 'none';
            if (player) player.loadVideoById(videoId);
            else {
                player = new YT.Player('youtube-player', {
                    videoId: videoId,
                    playerVars: { 'autoplay': 1, 'controls': 0, 'rel': 0, 'modestbranding': 1, 'iv_load_policy': 3 },
                    events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
                });
            }
        }

        function onPlayerReady(event) { event.target.playVideo(); }

        function onPlayerStateChange(event) {
            const playIcon = playPauseBtn.querySelector('i');
            clearInterval(progressInterval);
            if (event.data === YT.PlayerState.PLAYING) {
                playIcon.className = 'fas fa-pause';
                progressInterval = setInterval(updatePlayerProgress, 250);
            } else {
                playIcon.className = 'fas fa-play';
            }
            updateVolumeUI();
        }

        function updatePlayerProgress() {
            if (player && player.getDuration()) {
                progressBarFill.style.width = `${(player.getCurrentTime() / player.getDuration()) * 100}%`;
                timeDisplay.textContent = `${formatTime(player.getCurrentTime())} / ${formatTime(player.getDuration())}`;
            }
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '00:00';
            const m = Math.floor(seconds / 60), s = Math.floor(seconds % 60);
            return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        function updateVolumeUI() {
            if (!player) return;
            const muteIcon = muteBtn.querySelector('i');
            if (player.isMuted() || player.getVolume() === 0) {
                muteIcon.className = 'fas fa-volume-xmark';
                volumeSlider.value = 0;
            } else {
                muteIcon.className = 'fas fa-volume-high';
                volumeSlider.value = player.getVolume();
            }
        }

        playPauseBtn.addEventListener('click', () => { if (player) player.getPlayerState() === YT.PlayerState.PLAYING ? player.pauseVideo() : player.playVideo(); });
        muteBtn.addEventListener('click', () => { if (player) player.isMuted() ? player.unMute() : player.mute(); });
        volumeSlider.addEventListener('input', (e) => { if (player) { player.setVolume(e.target.value); if(player.isMuted()) player.unMute(); } });
        progressBarContainer.addEventListener('click', (e) => { if (player && player.getDuration()) { const r = progressBarContainer.getBoundingClientRect(); player.seekTo(((e.clientX - r.left) / r.width) * player.getDuration()); } });
        fullscreenBtn.addEventListener('click', () => { if (!document.fullscreenElement) playerWrapper.requestFullscreen(); else document.exitFullscreen(); });
        document.addEventListener('fullscreenchange', () => { fullscreenBtn.querySelector('i').className = `fas fa-${document.fullscreenElement ? 'compress' : 'expand'}`; });

        // --- INITIALIZATION ---
        const loginHandler = (e) => {
            e.preventDefault();
            if (document.getElementById('secret-code-input').value.trim().toUpperCase() === SECRET_CODE_FOR_LOGIN) {
                localStorage.setItem('loginToken', SECRET_CODE_FOR_LOGIN);
                accessLockOverlay.classList.add('opacity-0');
                setTimeout(() => { accessLockOverlay.style.display = 'none'; checkGradeSelection(); }, 700);
            }
        };
        loginForm.addEventListener('submit', loginHandler);
        if (localStorage.getItem('loginToken') === SECRET_CODE_FOR_LOGIN) {
            accessLockOverlay.style.display = 'none';
            checkGradeSelection();
        }
    });
    </script>
</body>
</html>
