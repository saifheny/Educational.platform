<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة دروسي التعليمية</title>
    
    <!-- UPDATED Meta Tags for Social Sharing -->
    <meta name="title" content="منصة دروسي التعليمية">
    <meta name="description" content="منصة تعليمية تجمع جميع المواد وتخفف على أولياء الأمور.">

    <!-- Open Graph / Facebook / WhatsApp -->
    <meta property="og:type" content="website">
    <meta property="og:url" content=""> <!-- You can add your website URL here -->
    <meta property="og:title" content="منصة دروسي التعليمية">
    <meta property="og:description" content="منصة تعليمية تجمع جميع المواد وتخفف على أولياء الأمور.">
    <meta property="og:image" content="https://i.postimg.cc/hGW3BBhY/Data-Science-and-Generative-AI-Course-Online-by-UT-Austin.jpg">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content=""> <!-- You can add your website URL here -->
    <meta property="twitter:title" content="منصة دروسي التعليمية">
    <meta property="twitter:description" content="منصة تعليمية تجمع جميع المواد وتخفف على أولياء الأمور.">
    <meta property="twitter:image" content="https://i.postimg.cc/hGW3BBhY/Data-Science-and-Generative-AI-Course-Online-by-UT-Austin.jpg">


    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --primary-color: #4f46e5;
            --font-family: 'Cairo', sans-serif;
        }
        html, body { scroll-behavior: smooth; }
        body { 
            font-family: var(--font-family); 
            background-color: #111827;
            background-image: url('https://i.postimg.cc/PxsVTM7W/download-40.jpg');
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
            -webkit-tap-highlight-color: transparent;
        }
        @media (min-width: 1024px) {
            body { background-image: url('https://i.postimg.cc/JnVYMQFj/download-41.jpg'); }
        }

        #access-lock-screen h2 { text-shadow: 0 4px 10px rgba(0,0,0,0.6); }
        #access-lock-screen p { text-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        #secret-code-input {
            background-color: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        #secret-code-input::placeholder { color: rgba(255, 255, 255, 0.4); }

        .element-3d {
            position: relative;
            transition: transform 0.15s ease-out, box-shadow 0.15s ease-out;
            cursor: pointer;
        }
        .element-3d.btn-style { border: 2px solid #4b5563; box-shadow: 0 5px 0 0 #4b5563; }
        .element-3d:hover { transform: translateY(-4px); }
        .element-3d.btn-style:hover { box-shadow: 0 9px 0 0 #374151; }
        .element-3d:active { transform: translateY(1px); }
        .element-3d.btn-style:active { box-shadow: 0 2px 0 0 #374151; }

        .grade-btn {
            display: flex; align-items: center; height: 80px; padding: 0 70px 0 50px; border: none;
            color: white; font-size: 1.5rem; font-weight: bold; position: relative;
            border-radius: 8px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); 
            box-shadow: 0 6px 0 0 rgba(0,0,0,0.25);
            transition: transform 0.15s ease-out, box-shadow 0.15s ease-out, filter 0.15s ease-out;
        }
        .grade-btn:hover { transform: translateY(-5px); box-shadow: 0 11px 0 0 rgba(0,0,0,0.25); filter: brightness(1.1); }
        .grade-btn:active { transform: translateY(1px); box-shadow: 0 2px 0 0 rgba(0,0,0,0.25); filter: brightness(0.95); }
        .grade-btn .number { font-size: 4.5rem; font-weight: 900; position: absolute; left: -15px; top: 50%; transform: translateY(-50%); z-index: 2; text-shadow: -4px 4px 0px rgba(0,0,0,0.25); }
        .grade-btn::after { content: ''; position: absolute; right: -40px; top: 0; width: 0; height: 0; border-top: 40px solid transparent; border-bottom: 40px solid transparent; }
        .grade-btn .text { width: 100%; text-align: center; }
        .btn-1 { background: linear-gradient(135deg, #2bc4b1, #1a9a8a); } .btn-1 .number { color: #1a9a8a; } .btn-1::after { border-left: 40px solid #1a9a8a; }
        .btn-2 { background: linear-gradient(135deg, #60d67a, #43b85d); } .btn-2 .number { color: #43b85d; } .btn-2::after { border-left: 40px solid #43b85d; }
        .btn-3 { background: linear-gradient(135deg, #6b9aeb, #4a7dca); } .btn-3 .number { color: #4a7dca; } .btn-3::after { border-left: 40px solid #4a7dca; }
        .btn-4 { background: linear-gradient(135deg, #a96aa9, #8b448b); } .btn-4 .number { color: #8b448b; } .btn-4::after { border-left: 40px solid #8b448b; }
        .btn-5 { background: linear-gradient(135deg, #f45d5a, #d63f3c); } .btn-5 .number { color: #d63f3c; } .btn-5::after { border-left: 40px solid #d63f3c; }

        .content-panel { background-color: rgba(241, 245, 249, 0.9); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .scrolling-wrapper { -ms-overflow-style: none; scrollbar-width: none; }
        .scrolling-wrapper::-webkit-scrollbar { display: none; }
        #dynamic-header-area { background-color: rgba(241, 245, 249, 0.7); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); }
        #volume-slider { accent-color: var(--primary-color); }

        #custom-controls-overlay button { transition: all 0.2s ease; }
        #custom-controls-overlay button:hover { transform: scale(1.15); color: white; }
        
        #search-overlay {
            background-color: rgba(17, 24, 39, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        #modal-search-input {
            background-color: rgba(42, 53, 71, 0.8);
            border-color: rgba(100, 116, 139, 0.5);
        }
        .search-result-card {
            background-color: rgba(29, 40, 58, 0.7);
            transition: background-color 0.2s ease-in-out;
        }
        .search-result-card:hover {
            background-color: rgba(51, 65, 85, 0.8);
        }
    </style>
</head>
<body class="antialiased text-slate-800">
    
    <!-- شاشة الدخول -->
    <div id="access-lock-screen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-md text-center">
            <h2 class="text-5xl md:text-6xl font-extrabold text-white mb-4">بوابة الدخول</h2>
            <p class="text-slate-200 text-lg mb-8">أدخل رمز الوصول للمتابعة.</p>
            <form id="login-form" class="space-y-6">
                <input type="text" id="secret-code-input" placeholder="● ● ● ● ● ●" maxlength="6" required class="w-full px-4 py-3 text-2xl tracking-[1.5rem] text-center rounded-xl focus:ring-indigo-500 focus:border-indigo-500">
                <button type="submit" class="w-full element-3d btn-style bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl">التحقق والمتابعة</button>
            </form>
            <div class="mt-8">
                <p class="text-slate-200 mb-3">ليس لديك رمز؟ تواصل معنا</p>
                <a href="https://wa.me/201202687082" target="_blank" class="inline-flex items-center gap-3 px-6 py-3 element-3d btn-style bg-green-500 text-white font-semibold rounded-full">
                    <i class="fab fa-whatsapp text-xl"></i> <span>اطلب رمزك عبر واتساب</span>
                </a>
            </div>
        </div>
    </div>
    
    <!-- شاشة اختيار الصفوف -->
    <div id="grade-selection-screen" class="fixed inset-0 z-40 justify-center p-4 hidden overflow-y-auto pt-24 pb-24">
        <div class="w-full max-w-2xl text-center my-auto">
            <div id="grade-selection-header" class="mb-12">
                 <h1 class="text-6xl font-extrabold text-white mb-4" style="text-shadow: 0 4px 8px rgba(0,0,0,0.4);"><i class="fas fa-graduation-cap"></i></h1>
                 <h2 class="text-4xl font-extrabold text-white mb-2" style="text-shadow: 0 2px 6px rgba(0,0,0,0.4);">أهلاً بك في دروسي</h2>
                 <p class="text-slate-200 text-lg">اختر صفك الدراسي للبدء</p>
            </div>
            <div id="grade-options" class="flex flex-col gap-10"></div>
            <div id="specialization-options" class="hidden mt-6">
                <h3 class="text-2xl font-bold text-white mb-6" style="text-shadow: 0 2px 4px rgba(0,0,0,0.3);">اختر تخصصك</h3>
                <div id="specialization-buttons" class="flex justify-center gap-6"></div>
            </div>
        </div>
    </div>

    <!-- المنصة الرئيسية -->
    <main id="main-platform" class="hidden text-slate-800">
        <div class="lg:flex lg:flex-row-reverse lg:h-screen">
            <!-- منطقة عرض الفيديو -->
            <div class="video-display-area w-full bg-slate-900 lg:flex-grow lg:sticky lg:top-0 lg:h-screen flex flex-col">
                
                <div id="platform-header" class="w-full p-4 bg-slate-900/80 backdrop-blur-sm z-40 flex items-center justify-between shrink-0">
                    <h1 class="text-2xl font-extrabold text-white">
                        <i class="fas fa-book-open text-indigo-400"></i> منصة <span class="text-indigo-400">دروسي</span>
                    </h1>
                    <button id="open-search-btn" class="w-12 h-11 flex items-center justify-center text-white text-xl rounded-lg hover:bg-slate-700 transition-colors">
                        <i class="fas fa-search"></i>
                    </button>
                </div>

                <div id="player-wrapper" class="w-full h-full relative flex-grow min-h-[250px]">
                    <div id="player-placeholder" class="w-full h-full flex flex-col justify-center items-center text-center p-4 bg-slate-900 z-10">
                        <i class="fas fa-play-circle text-6xl mb-4 text-indigo-400/50"></i>
                        <p class="font-semibold text-slate-300">اختر فيديو لبدء المشاهدة</p>
                    </div>
                    <div id="youtube-player" class="w-full h-full"></div>
                    <div id="click-blocker-overlay" class="absolute inset-0 z-20"></div>
                    
                    <div id="custom-controls-overlay" class="absolute bottom-0 inset-x-0 z-30 p-2 sm:p-4 flex-col gap-2 bg-gradient-to-t from-black/80 to-transparent hidden">
                        <div id="progress-bar-container" class="w-full h-1.5 hover:h-2.5 bg-white/20 cursor-pointer rounded-full"><div id="progress-bar-fill" class="h-full rounded-full w-0 bg-indigo-500"></div></div>
                        <div class="controls-bottom-row flex items-center gap-2 sm:gap-4 text-white">
                            <button id="play-pause-btn" class="text-2xl w-8 h-8 flex shrink-0 items-center justify-center text-indigo-300"><i class="fas fa-play"></i></button>
                            <div class="flex items-center gap-2"><button id="mute-btn" class="text-xl w-8 h-8 flex shrink-0 items-center justify-center text-indigo-300"><i class="fas fa-volume-up"></i></button><input type="range" id="volume-slider" min="0" max="100" value="100" class="w-16 sm:w-20 h-1 cursor-pointer"></div>
                            <div id="time-display" class="text-sm font-mono tracking-tighter" style="direction: ltr;">00:00/00:00</div>
                            <div class="flex-grow"></div>
                            <button id="speed-btn" class="text-sm font-semibold w-12 h-8 flex shrink-0 items-center justify-center text-indigo-300 rounded">1x</button>
                            <button id="fullscreen-btn" class="text-xl w-8 h-8 flex shrink-0 items-center justify-center text-indigo-300"><i class="fas fa-expand"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- منطقة المحتوى -->
            <div class="w-full lg:w-[400px] lg:flex-shrink-0 lg:h-screen lg:overflow-y-auto">
                <div class="content-panel min-h-full">
                    <div id="dynamic-header-area" class="sticky top-0 z-20 p-4 space-y-4 border-b border-slate-200/50">
                        <div id="main-view-header" class="hidden">
                            <div id="grade-header" class="items-center gap-3 bg-white/50 rounded-2xl shadow-sm border border-slate-200 p-4"></div>
                            <div id="category-filters" class="scrolling-wrapper flex items-center gap-3 overflow-x-auto pt-2 pb-2"></div>
                        </div>
                        <div id="sub-view-header" class="hidden items-center">
                            <button id="back-btn" class="element-3d btn-style rounded-full w-10 h-10 flex items-center justify-center bg-white text-slate-700 ml-3"><i class="fas fa-arrow-left"></i></button>
                            <h2 id="view-title" class="font-bold text-lg text-slate-800 truncate"></h2>
                        </div>
                    </div>
                    <div id="content-list" class="p-4 space-y-4"></div>
                </div>
            </div>
        </div>
        <!-- زر الدعم الفني العائم -->
        <a href="https://wa.me/201202687082" target="_blank" id="support-btn" class="fixed bottom-6 left-6 z-30 w-16 h-16 bg-green-500 rounded-full flex items-center justify-center text-white shadow-lg transition-transform hover:scale-110">
            <i class="fab fa-whatsapp text-3xl"></i>
        </a>
    </main>

    <!-- Search Overlay -->
    <div id="search-overlay" class="hidden fixed inset-0 z-50 p-4 pt-[15vh] overflow-y-auto">
        <div class="w-full max-w-2xl mx-auto">
            <form id="modal-search-form" class="flex items-center gap-2 relative">
                <input type="search" id="modal-search-input" placeholder="ابحث عن أي درس تريده..." class="w-full text-white placeholder-slate-400 rounded-lg py-3 px-5 text-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 border-2">
                <button type="submit" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xl hover:text-white">
                    <i class="fas fa-search"></i>
                </button>
            </form>
            <div id="search-results-container" class="mt-6 space-y-3 max-h-[60vh] overflow-y-auto">
                <!-- Search results will be injected here by JavaScript -->
            </div>
        </div>
        <button id="close-search-btn" class="absolute top-6 right-6 text-slate-400 text-3xl hover:text-white">&times;</button>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    
    <script>
    // --- ملاحظة: يجب استبدال المفتاح بمفتاح واجهة برمجة تطبيقات يوتيوب الخاص بك ---
    const YOUTUBE_API_KEY = "AIzaSyA4gfRf5sGQZ-a7ficcTcgU47aJV30cSgc";
    
    document.addEventListener('DOMContentLoaded', () => {
        // --- الثوابت والمتغيرات العامة ---
        const SECRET_CODE_FOR_LOGIN = "SASAIF";
        let player, progressInterval;
        let currentSubjectQuery, currentSubjectName;
        const playbackRates = [1, 1.25, 1.5, 2, 0.75];
        let currentRateIndex = 0;

        const appData = {
            grades: {
                prep_1: { name: "الصف الأول الإعدادي", subjects: [ { n: 'عربي', q: 'شرح لغة عربية' }, { n: 'علوم', q: 'شرح علوم' }, { n: 'رياضة', q: 'شرح رياضيات' }, { n: 'إنجليزي', q: 'شرح لغة انجليزية' }, { n: 'دراسات', q: 'شرح دراسات اجتماعية' } ] },
                prep_2: { name: "الصف الثاني الإعدادي", subjects: [ { n: 'عربي', q: 'شرح لغة عربية' }, { n: 'علوم', q: 'شرح علوم' }, { n: 'رياضة', q: 'شرح رياضيات' }, { n: 'إنجليزي', q: 'شرح لغة انجليزية' }, { n: 'دراسات', q: 'شرح دراسات اجتماعية' } ] },
                prep_3: { name: "الصف الثالث الإعدادي", subjects: [ { n: 'عربي', q: 'شرح لغة عربية' }, { n: 'علوم', q: 'شرح علوم' }, { n: 'رياضة', q: 'شرح رياضيات' }, { n: 'إنجليزي', q: 'شرح لغة انجليزية' }, { n: 'دراسات', q: 'شرح دراسات اجتماعية' } ] },
                sec_1: { name: "الصف الأول الثانوي", subjects: [ { n: 'عربي', q: 'شرح اللغة العربية' },  { n: 'فيزياء', q: 'شرح فيزياء' }, { n: 'كيمياء', q: 'شرح كيمياء' }, { n: 'إنجليزي', q: 'شرح اللغة الانجليزية' }, { n: 'رياضة', q: 'شرح رياضيات' } ] },
                sec_2_sci: { name: "الصف الثاني الثانوي - علمي", subjects: [ { n: 'عربي', q: 'شرح لغة عربية' }, { n: 'فيزياء', q: 'شرح فيزياء' }, { n: 'كيمياء', q: 'شرح كيمياء' }, { n: 'رياضة', q: 'شرح رياضيات' }, { n: 'إنجليزي', q: 'شرح لغة انجليزية' } ] },
                sec_2_lit: { name: "الصف الثاني الثانوي - أدبي", subjects: [ { n: 'عربي', q: 'شرح لغة عربية' }, { n: 'تاريخ', q: 'شرح تاريخ' }, { n: 'جغرافيا', q: 'شرح جغرافيا' }, { n: 'إنجليزي', q: 'شرح لغة انجليزية' }, { n: 'فلسفة وعلم نفس', q: 'شرح فلسفة وعلم نفس' } ] }
            },
            gradeButtons: [
                { id: 'prep_1', name: "الصف الأول الإعدادي", number: '1', class: 'btn-1' },
                { id: 'prep_2', name: "الصف الثاني الإعدادي", number: '2', class: 'btn-2' },
                { id: 'prep_3', name: "الصف الثالث الإعدادي", number: '3', class: 'btn-3' },
                { id: 'sec_1', name: "الصف الأول الثانوي", number: '4', class: 'btn-4' },
                { id: 'sec_2', name: "الصف الثاني الثانوي", number: '5', class: 'btn-5' },
            ],
            currentUser: { gradeId: null, gradeData: null }
        };

        // --- محددات عناصر DOM ---
        const allDOMElements = {
            accessLockScreen: document.getElementById('access-lock-screen'),
            loginForm: document.getElementById('login-form'),
            gradeSelectionScreen: document.getElementById('grade-selection-screen'),
            mainPlatform: document.getElementById('main-platform'),
            contentList: document.getElementById('content-list'),
            mainViewHeader: document.getElementById('main-view-header'),
            subViewHeader: document.getElementById('sub-view-header'),
            backBtn: document.getElementById('back-btn'),
            categoryFiltersDiv: document.getElementById('category-filters'),
            playerWrapper: document.getElementById('player-wrapper'),
            customControlsOverlay: document.getElementById('custom-controls-overlay'),
            playPauseBtn: document.getElementById('play-pause-btn'),
            muteBtn: document.getElementById('mute-btn'),
            volumeSlider: document.getElementById('volume-slider'),
            fullscreenBtn: document.getElementById('fullscreen-btn'),
            progressBarFill: document.getElementById('progress-bar-fill'),
            progressBarContainer: document.getElementById('progress-bar-container'),
            timeDisplay: document.getElementById('time-display'),
            openSearchBtn: document.getElementById('open-search-btn'),
            closeSearchBtn: document.getElementById('close-search-btn'),
            searchOverlay: document.getElementById('search-overlay'),
            modalSearchForm: document.getElementById('modal-search-form'),
            modalSearchInput: document.getElementById('modal-search-input'),
            searchResultsContainer: document.getElementById('search-results-container'),
            speedBtn: document.getElementById('speed-btn')
        };
        
        function showScreen(screen) {
            allDOMElements.accessLockScreen.classList.add('hidden');
            allDOMElements.gradeSelectionScreen.classList.add('hidden');
            allDOMElements.mainPlatform.classList.add('hidden');
            screen.classList.remove('hidden');
            if (screen === allDOMElements.gradeSelectionScreen) screen.classList.add('flex');
        }

        function displayGradeSelection() { 
            showScreen(allDOMElements.gradeSelectionScreen);
            const gradeOptionsContainer = document.getElementById('grade-options');
            const specializationOptions = document.getElementById('specialization-options');
            gradeOptionsContainer.innerHTML = '';
            gradeOptionsContainer.classList.remove('hidden');
            specializationOptions.classList.add('hidden');
            document.getElementById('grade-selection-header').classList.remove('hidden');

            appData.gradeButtons.forEach(grade => {
                const btn = document.createElement('button');
                btn.className = `grade-btn ${grade.class}`;
                btn.innerHTML = `<span class="number">${grade.number}</span> <span class="text">${grade.name}</span>`;
                btn.addEventListener('click', () => {
                    if (grade.id === 'sec_2') {
                        promptSpecialization();
                    } else {
                        startAppForGrade(grade.id);
                    }
                });
                gradeOptionsContainer.appendChild(btn);
            });
        }
        
        function promptSpecialization() {
            document.getElementById('grade-options').classList.add('hidden');
            document.getElementById('grade-selection-header').classList.add('hidden');
            const specializationOptions = document.getElementById('specialization-options');
            const specializationButtons = document.getElementById('specialization-buttons');
            specializationButtons.innerHTML = ''; 
            
            const choices = [
                { id: 'sec_2_sci', name: 'علمي', emoji: '🔬', color: 'bg-sky-400' },
                { id: 'sec_2_lit', name: 'أدبي', emoji: '🏛️', color: 'bg-orange-400' }
            ];

            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = `element-3d btn-style w-40 text-white font-bold py-4 px-6 rounded-xl text-xl ${choice.color}`;
                btn.innerHTML = `<span class="text-3xl">${choice.emoji}</span><br>${choice.name}`;
                btn.addEventListener('click', () => startAppForGrade(choice.id));
                specializationButtons.appendChild(btn);
            });

            specializationOptions.classList.remove('hidden');
        }

        function startAppForGrade(gradeId) {
            localStorage.setItem('userGrade', gradeId);
            appData.currentUser = { gradeId: gradeId, gradeData: appData.grades[gradeId] };
            showScreen(allDOMElements.mainPlatform);
            initializeApp();
        }

        function initializeApp() {
            const gradeHeader = document.getElementById('grade-header');

            gradeHeader.innerHTML = `
                <h2 class="font-extrabold text-lg text-slate-800 flex-grow">${appData.currentUser.gradeData.name}</h2>
                <button id="change-grade-btn" class="text-xs text-slate-600 hover:text-indigo-600 font-semibold">تغيير</button>
                <button id="logout-btn" class="text-xs text-red-600 hover:text-red-800 font-semibold mr-3"><i class="fas fa-sign-out-alt ml-1"></i>خروج</button>
            `;
            gradeHeader.classList.remove('hidden'); gradeHeader.classList.add('flex');
            
            document.getElementById('change-grade-btn').addEventListener('click', () => { 
                localStorage.removeItem('userGrade');
                displayGradeSelection(); 
            });
            document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.removeItem('loginToken');
                localStorage.removeItem('userGrade');
                window.location.reload();
            });

            function switchView(viewName, title = '') {
                allDOMElements.contentList.innerHTML = '';
                if (viewName === 'main') {
                    allDOMElements.mainViewHeader.style.display = 'block';
                    allDOMElements.subViewHeader.style.display = 'none';
                    renderCategoryFilters();
                } else {
                    allDOMElements.mainViewHeader.style.display = 'none';
                    allDOMElements.subViewHeader.style.display = 'flex';
                    document.getElementById('view-title').textContent = title;
                }
            }

            function renderCategoryFilters() {
                const categories = appData.currentUser.gradeData.subjects;
                allDOMElements.categoryFiltersDiv.innerHTML = ''; 
                categories.forEach((cat) => {
                    const btn = document.createElement('button');
                    btn.className = 'category-filter element-3d btn-style shrink-0 px-4 py-2 rounded-full text-sm font-semibold text-slate-700 bg-white';
                    btn.textContent = cat.n;
                    btn.addEventListener('click', () => {
                        currentSubjectQuery = cat.q;
                        currentSubjectName = cat.n;
                        fetchFromYouTube('video');
                    });
                    allDOMElements.categoryFiltersDiv.appendChild(btn);
                });
            }
            
            function createToggle(currentType) {
                const toggleContainer = document.createElement('div');
                toggleContainer.className = "flex justify-center p-2 mb-4";
                const isVideo = currentType === 'video';
                toggleContainer.innerHTML = `<div class="element-3d btn-style flex items-center bg-white rounded-full p-1 text-sm font-semibold"><button class="toggle-btn w-28 py-2 rounded-full ${isVideo ? 'bg-indigo-600 text-white' : 'text-slate-600'}" data-type="video"><i class="fas fa-video mr-2"></i>الفيديوهات</button><button class="toggle-btn w-28 py-2 rounded-full ${!isVideo ? 'bg-indigo-600 text-white' : 'text-slate-600'}" data-type="playlist"><i class="fas fa-list-ul mr-2"></i>القوائم</button></div>`;
                toggleContainer.querySelectorAll('.toggle-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const type = e.currentTarget.dataset.type;
                        if(type !== currentType) fetchFromYouTube(type);
                    });
                });
                return toggleContainer;
            }

            async function fetchFromYouTube(type, queryOverride = null) {
                const isPlaylistItems = type === 'playlistItems';
                const searchType = isPlaylistItems ? 'playlistItems' : (type === 'playlist' ? 'playlist' : 'video');
                const isCustomSearch = !!queryOverride && !isPlaylistItems;
                const query = queryOverride || currentSubjectQuery;
                const title = isCustomSearch ? `نتائج البحث عن: "${query}"` : `مادة: ${currentSubjectName}`;
                
                switchView('sub-view', title);
                allDOMElements.contentList.innerHTML = '<p class="text-center p-4">جاري التحميل...</p>';

                const gradeName = appData.currentUser.gradeData.name.replace(/ - .*/, '');
                const fullQuery = isCustomSearch ? query : `${query} ${gradeName}`;
                
                let apiUrl;
                if(isPlaylistItems) {
                    apiUrl = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${queryOverride}&maxResults=50&key=${YOUTUBE_API_KEY}`;
                } else {
                    apiUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(fullQuery)}&type=${searchType}&maxResults=20&key=${YOUTUBE_API_KEY}`;
                }

                try {
                    const res = await fetch(apiUrl);
                    if (!res.ok) throw new Error(`فشل في جلب البيانات`);
                    const data = await res.json();
                    allDOMElements.contentList.innerHTML = '';
                    if (!isPlaylistItems) allDOMElements.contentList.appendChild(createToggle(type));
                    if (data.items && data.items.length > 0) {
                        if (type === 'playlist') data.items.forEach(item => allDOMElements.contentList.appendChild(createCard(item, 'playlist')));
                        else if (type === 'video') data.items.forEach(item => allDOMElements.contentList.appendChild(createCard(item, 'video')));
                        else if (isPlaylistItems) data.items.forEach(item => allDOMElements.contentList.appendChild(createCard(item, 'playlistItem')));
                    } else { allDOMElements.contentList.innerHTML += '<p class="text-center p-4 text-slate-600">لم يتم العثور على نتائج.</p>'; }
                } catch (err) { allDOMElements.contentList.innerHTML = `<p class="text-center p-4 text-red-600">حدث خطأ: ${err.message}</p>`; }
             }

            function createCard(item, type) {
                const card = document.createElement("div");
                card.className = "element-3d btn-style bg-white rounded-xl overflow-hidden";
                let videoId, playlistId, title, thumbnailUrl;

                switch (type) {
                    case 'video': videoId = item.id.videoId; title = item.snippet.title; thumbnailUrl = item.snippet.thumbnails.high?.url; card.addEventListener("click", () => { createPlayer(videoId); allDOMElements.playerWrapper.scrollIntoView(); }); break;
                    case 'playlist': playlistId = item.id.playlistId; title = item.snippet.title; thumbnailUrl = item.snippet.thumbnails.high?.url; card.addEventListener('click', () => fetchFromYouTube('playlistItems', playlistId)); break;
                    case 'playlistItem': videoId = item.snippet.resourceId.videoId; title = item.snippet.title; thumbnailUrl = item.snippet.thumbnails.medium?.url; card.addEventListener("click", () => { createPlayer(videoId); allDOMElements.playerWrapper.scrollIntoView(); }); break;
                }
                card.innerHTML = `<img src="${thumbnailUrl || ''}" class="aspect-video w-full object-cover bg-slate-200"><div class="p-4"><h3 class="font-bold text-sm text-slate-800 leading-tight line-clamp-2">${title}</h3></div>`;
                return card;
            }
            
            allDOMElements.backBtn.addEventListener('click', () => switchView('main'));
            
            const categories = appData.currentUser.gradeData.subjects;
            const arabicSubject = categories.find(cat => cat.n === 'عربي') || (categories.length > 0 ? categories[0] : null);
            
            if (arabicSubject) {
                currentSubjectQuery = arabicSubject.q;
                currentSubjectName = arabicSubject.n;
                fetchFromYouTube('video'); 
            } else {
                switchView('main');
                allDOMElements.contentList.innerHTML = '<p class="text-center p-4 text-slate-600">لا توجد مواد متاحة لهذا الصف.</p>';
            }
        }

        async function performModalSearch(searchTerm) {
            const resultsContainer = allDOMElements.searchResultsContainer;
            resultsContainer.innerHTML = '<p class="text-center text-white">جاري البحث...</p>';
            const apiUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(searchTerm)}&type=video&maxResults=15&key=${YOUTUBE_API_KEY}`;
            try {
                const res = await fetch(apiUrl);
                if (!res.ok) throw new Error('فشل في جلب البيانات');
                const data = await res.json();
                resultsContainer.innerHTML = '';
                if (data.items && data.items.length > 0) {
                    data.items.forEach(item => {
                        const card = createSearchResultCard(item);
                        resultsContainer.appendChild(card);
                    });
                } else {
                    resultsContainer.innerHTML = '<p class="text-center text-slate-400">لم يتم العثور على نتائج.</p>';
                }
            } catch (err) {
                resultsContainer.innerHTML = `<p class="text-center text-red-500">حدث خطأ: ${err.message}</p>`;
            }
        }

        function createSearchResultCard(item) {
            const card = document.createElement("div");
            card.className = "search-result-card flex items-center gap-4 p-3 rounded-lg cursor-pointer";
            const videoId = item.id.videoId;
            const title = item.snippet.title;
            const thumbnailUrl = item.snippet.thumbnails.default.url;
            
            card.innerHTML = `
                <img src="${thumbnailUrl}" class="w-24 h-16 object-cover rounded bg-slate-700 shrink-0">
                <h3 class="font-semibold text-sm text-white leading-tight line-clamp-2">${title}</h3>
            `;
            
            card.addEventListener("click", () => {
                createPlayer(videoId);
                allDOMElements.searchOverlay.classList.add('hidden');
                allDOMElements.modalSearchInput.value = '';
                allDOMElements.searchResultsContainer.innerHTML = '';
            });
            return card;
        }

        function createPlayer(videoId) {
            document.getElementById('player-placeholder').style.display = 'none';
            allDOMElements.customControlsOverlay.classList.remove('hidden');
            allDOMElements.customControlsOverlay.classList.add('flex');
            if (player) {
                player.loadVideoById(videoId);
            } else {
                player = new YT.Player('youtube-player', {
                    videoId: videoId,
                    playerVars: { 'autoplay': 1, 'controls': 0, 'rel': 0, 'modestbranding': 1, 'iv_load_policy': 3 },
                    events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
                });
            }
        }

        function onPlayerReady(event) {
            event.target.playVideo();
            currentRateIndex = 0;
            const initialRate = playbackRates[currentRateIndex];
            player.setPlaybackRate(initialRate);
            allDOMElements.speedBtn.textContent = `${initialRate}x`;
        }

        function onPlayerStateChange(event) {
            const playIcon = allDOMElements.playPauseBtn.querySelector('i');
            clearInterval(progressInterval);
            if (event.data === YT.PlayerState.PLAYING) {
                playIcon.className = 'fas fa-pause';
                progressInterval = setInterval(updatePlayerProgress, 250);
            } else { playIcon.className = 'fas fa-play'; }
        }

        function updatePlayerProgress() {
            if (player && player.getDuration()) {
                allDOMElements.progressBarFill.style.width = `${(player.getCurrentTime() / player.getDuration()) * 100}%`;
                allDOMElements.timeDisplay.textContent = `${formatTime(player.getCurrentTime())}/${formatTime(player.getDuration())}`;
            }
        }

        function formatTime(s) { return new Date(s * 1000).toISOString().substr(14, 5); }
        
        allDOMElements.playPauseBtn.addEventListener('click', () => { if (player) player.getPlayerState() === 1 ? player.pauseVideo() : player.playVideo(); });
        allDOMElements.muteBtn.addEventListener('click', () => { if (player) player.isMuted() ? player.unMute() : player.mute(); });
        allDOMElements.volumeSlider.addEventListener('input', (e) => { if (player) player.setVolume(e.target.value); });
        allDOMElements.progressBarContainer.addEventListener('click', (e) => { const r = e.currentTarget.getBoundingClientRect(); player.seekTo(((e.clientX - r.left) / r.width) * player.getDuration()); });
        allDOMElements.fullscreenBtn.addEventListener('click', () => { if (!document.fullscreenElement) allDOMElements.playerWrapper.requestFullscreen(); else document.exitFullscreen(); });
        
        allDOMElements.speedBtn.addEventListener('click', () => {
            if (player) {
                currentRateIndex = (currentRateIndex + 1) % playbackRates.length;
                const newRate = playbackRates[currentRateIndex];
                player.setPlaybackRate(newRate);
                allDOMElements.speedBtn.textContent = `${newRate}x`;
            }
        });

        allDOMElements.openSearchBtn.addEventListener('click', () => {
            allDOMElements.searchOverlay.classList.remove('hidden');
            allDOMElements.modalSearchInput.focus();
        });

        const closeSearch = () => allDOMElements.searchOverlay.classList.add('hidden');
        allDOMElements.closeSearchBtn.addEventListener('click', closeSearch);
        allDOMElements.searchOverlay.addEventListener('click', (e) => {
            if (e.target === allDOMElements.searchOverlay) closeSearch();
        });

        allDOMElements.modalSearchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const searchTerm = allDOMElements.modalSearchInput.value.trim();
            if (searchTerm) {
                performModalSearch(searchTerm);
            }
        });

        const loginHandler = (e) => {
            e.preventDefault();
            if (document.getElementById('secret-code-input').value.trim().toUpperCase() === SECRET_CODE_FOR_LOGIN) {
                localStorage.setItem('loginToken', SECRET_CODE_FOR_LOGIN);
                displayGradeSelection();
            } else { alert("رمز الدخول غير صحيح."); }
        };
        allDOMElements.loginForm.addEventListener('submit', loginHandler);
        
        if (localStorage.getItem('loginToken') === SECRET_CODE_FOR_LOGIN) {
            const savedGrade = localStorage.getItem('userGrade');
            if (savedGrade && appData.grades[savedGrade]) {
                startAppForGrade(savedGrade);
            } else {
                displayGradeSelection();
            }
        } else {
            showScreen(allDOMElements.accessLockScreen);
        }
    });
    </script>
</body>
</html>
